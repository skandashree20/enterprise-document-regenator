{
  "id": "G1NX0hEbyVM407us",
  "name": "01 - Main Orchestrator",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-regeneration",
        "options": {}
      },
      "id": "manual-trigger",
      "name": "Manual Trigger (Webhook)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        200
      ],
      "webhookId": "run-regeneration"
    },
    {
      "parameters": {},
      "id": "merge-triggers",
      "name": "Merge Triggers",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        220,
        100
      ]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "var1",
              "name": "execution_id",
              "value": "={{ $execution.id }}",
              "type": "string"
            },
            {
              "id": "var2",
              "name": "start_time",
              "value": "={{ $now.toISOString() }}",
              "type": "string"
            },
            {
              "id": "var3",
              "name": "source_folder_ids",
              "value": "[\"18BLoYEzkKvHVyCe0tylsFXiF801aK7dd\"]",
              "type": "string"
            },
            {
              "id": "var4",
              "name": "output_folder_id",
              "value": "1WftdViMVQYdZ-XLULYjKpP00cLQ3UrBO",
              "type": "string"
            },
            {
              "id": "var5",
              "name": "batch_size",
              "value": "5",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "init-vars",
      "name": "Initialize Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        440,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const staticData = $getWorkflowStaticData('global');\nstaticData.accumulated_docs = [];\nreturn $input.all();"
      },
      "id": "clear-static",
      "name": "Clear Static Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        550,
        100
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "2acc5886-b7f6-47"
        },
        "options": {}
      },
      "id": "fetch-snippet",
      "name": "Fetch Company Snippet",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        660,
        0
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "cb2b39eb-a61a-41"
        },
        "options": {}
      },
      "id": "fetch-enrichment",
      "name": "Fetch Enrichment Data",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        660,
        200
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "numberInputs": 3,
        "options": {}
      },
      "id": "merge-context",
      "name": "Merge Context",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        880,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst initVars = $('Initialize Variables').first().json;\n\nlet context = {\n  company_snippet: null,\n  enrichment_data: null,\n  config: { source_folder_ids: [], output_folder_id: '', batch_size: 5 }\n};\n\ntry {\n  const folderIds = initVars.source_folder_ids;\n  context.config.source_folder_ids = typeof folderIds === 'string' ? JSON.parse(folderIds) : folderIds;\n} catch (e) {\n  context.config.source_folder_ids = [];\n}\ncontext.config.output_folder_id = initVars.output_folder_id || '';\ncontext.config.batch_size = parseInt(initVars.batch_size) || 5;\n\nfor (const item of items) {\n  if (item.json.company_snippet) context.company_snippet = item.json.company_snippet;\n  if (item.json.edtech_news || item.json.ferpa_updates) context.enrichment_data = item.json;\n}\n\nreturn [{ json: context }];"
      },
      "id": "combine-context",
      "name": "Combine Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        100
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "f77af28e-f432-4e"
        },
        "options": {}
      },
      "id": "scan-drive",
      "name": "Scan Google Drive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1320,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst documents = item.json.documents || [];\nconst context = item.json;\n\nif (documents.length === 0) {\n  return [{ json: { status: 'no_documents', message: 'No documents found to process', context: context } }];\n}\n\nreturn documents.map(doc => ({\n  json: { ...doc, company_snippet: context.company_snippet, enrichment_data: context.enrichment_data, config: context.config }\n}));"
      },
      "id": "prepare-docs",
      "name": "Prepare Documents",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        100
      ]
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.file_id }}"
        },
        "options": {}
      },
      "id": "download-file",
      "name": "Download from Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        1760,
        100
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "22BxZvZno0IrY9iC",
          "name": "Google Drive account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "http://n8n-tika:9998/tika",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "text/plain"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "=data",
        "options": {
          "timeout": 120000
        }
      },
      "id": "tika-extract",
      "name": "Tika Extract Text",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1980,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Process ALL items from Tika, not just the first one\nconst items = $input.all();\nconst preparedItems = $('Prepare Documents').all();\n\nreturn items.map((item, index) => {\n  const tikaResponse = item.json;\n  const preparedDoc = preparedItems[index]?.json || {};\n\n  const fileName = preparedDoc.file_name || 'unknown';\n  const fileId = preparedDoc.file_id || '';\n  const extension = (preparedDoc.extension || fileName.split('.').pop() || '').toLowerCase();\n  const mimeType = preparedDoc.mime_type || 'application/octet-stream';\n\n  let extractedText = '';\n  let processorType = 'tika';\n  let status = 'processed';\n\n  if (tikaResponse.error || tikaResponse.code || (tikaResponse.statusCode && tikaResponse.statusCode >= 400)) {\n    extractedText = `Tika extraction failed: ${tikaResponse.error || tikaResponse.message || JSON.stringify(tikaResponse)}`;\n    processorType = 'tika_error';\n    status = 'error';\n  } else if (typeof tikaResponse === 'string') {\n    extractedText = tikaResponse;\n  } else if (tikaResponse.data) {\n    extractedText = tikaResponse.data;\n  } else {\n    extractedText = JSON.stringify(tikaResponse);\n  }\n\n  if (extractedText && typeof extractedText === 'string') {\n    extractedText = extractedText.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n').replace(/\\n{3,}/g, '\\n\\n').trim();\n  }\n\n  if (!extractedText || extractedText.length < 50) {\n    extractedText = `Document: ${fileName}\\nType: ${extension.toUpperCase()} file\\nNote: Text extraction returned minimal content.`;\n    processorType = 'placeholder';\n  }\n\n  return {\n    json: {\n      file_id: fileId,\n      file_name: fileName,\n      mime_type: mimeType,\n      extension: extension,\n      file_size: preparedDoc.file_size || 0,\n      status: status,\n      processor_type: processorType,\n      extracted_text: extractedText.substring(0, 50000),\n      text_length: extractedText.length,\n      processed_at: new Date().toISOString()\n    }\n  };\n});"
      },
      "id": "format-tika",
      "name": "Format Tika Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2200,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst processedDocs = items.map(item => item.json);\nconst context = $('Combine Context').first().json;\n\nconst debugInfo = {\n  input_count: processedDocs.length,\n  sample_doc: processedDocs[0] ? Object.keys(processedDocs[0]) : [],\n  has_extracted_text: processedDocs[0]?.extracted_text ? true : false,\n  first_doc_text_length: processedDocs[0]?.text_length || 0,\n  first_doc_text_preview: processedDocs[0]?.extracted_text?.substring(0, 200) || 'none'\n};\n\nif (processedDocs.length === 0) {\n  return [{ json: { status: 'no_documents', message: 'No documents received.', debug: debugInfo } }];\n}\n\nreturn processedDocs.map((doc, i) => ({\n  json: {\n    ...doc,\n    analyzer_workflow: i % 2 === 0 ? '08 - Document Analyzer OpenAI' : '09 - Document Analyzer Gemini',\n    company_snippet: context.company_snippet,\n    enrichment_data: context.enrichment_data,\n    debug_prepare: debugInfo\n  }\n}));"
      },
      "id": "prepare-analysis",
      "name": "Prepare for Analysis",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2420,
        100
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "98757030-1bfb-4f"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "analyze-doc",
      "name": "Analyze Document",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2640,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "analyzed_documents",
        "options": {}
      },
      "id": "aggregate-analyzed",
      "name": "Aggregate Analyzed",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2860,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare each analyzed document for update checking\n// Merge analysis results with original extracted text\nconst items = $input.all();\nconst tikaItems = $('Format Tika Response').all();\nconst context = $('Combine Context').first().json;\n\nreturn items.map((item, index) => {\n  const analysis = item.json.analysis || item.json;\n  const tikaData = tikaItems[index]?.json || {};\n  \n  return {\n    json: {\n      file_id: item.json.file_id || tikaData.file_id,\n      file_name: item.json.file_name || tikaData.file_name,\n      extracted_text: tikaData.extracted_text || '',\n      analysis: analysis,\n      output_folder_id: context.config?.output_folder_id || '',\n      config: context.config\n    }\n  };\n});"
      },
      "id": "prepare-update",
      "name": "Prepare for Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2860,
        300
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "DOC_UPDATER_001"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "update-doc",
      "name": "Update Document",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3080,
        300
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "needs-update",
              "leftValue": "={{ $json.needs_update }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "filter-updated",
      "name": "Filter Updated Docs",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        3300,
        300
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "sWcRjhQCUTDbZW0h"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "upload-updated",
      "name": "Upload Updated Docs",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3520,
        250
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Log skipped documents (no updates needed)\nconst items = $input.all();\nreturn items.map(item => ({\n  json: {\n    file_name: item.json.file_name,\n    status: 'no_update_needed',\n    reason: item.json.update_summary || 'Document is up to date'\n  }\n}));"
      },
      "id": "log-skipped",
      "name": "Log Skipped Updates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3520,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst analyzedDocs = item.json.analyzed_documents || [];\nconst context = item.json;\nconst combineContext = $('Combine Context').first().json;\nconst outputFolderId = combineContext.config?.output_folder_id || '';\n\nconst generationRequests = [\n  { generator_id: 'Adlw6GFK6dfNNZ7X', generator_name: '12 - Corporate Overview Generator', document_type: 'corporate_overview', analyzed_documents: analyzedDocs, company_snippet: context.company_snippet, enrichment_data: context.enrichment_data, output_folder_id: outputFolderId },\n  { generator_id: 'ZhLZfoIafT5fDoq7', generator_name: '13 - Product Datasheet Generator', document_type: 'product_datasheet', product_name: 'AIRR', analyzed_documents: analyzedDocs, company_snippet: context.company_snippet, enrichment_data: context.enrichment_data, output_folder_id: outputFolderId },\n  { generator_id: 'DeeROqhJo4eQcfYk', generator_name: '14 - Higher Ed One-Pager Generator', document_type: 'higher_ed_onepager', analyzed_documents: analyzedDocs, company_snippet: context.company_snippet, enrichment_data: context.enrichment_data, output_folder_id: outputFolderId }\n];\n\nreturn generationRequests.map(req => ({ json: req }));"
      },
      "id": "route-generators",
      "name": "Route to Generators",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3080,
        100
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.generator_id }}"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "generate-doc",
      "name": "Generate Document",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3300,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "eNk7PykRD4mFqREB"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "generate-visuals",
      "name": "Generate Visuals",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3520,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "sWcRjhQCUTDbZW0h"
        },
        "options": {
          "mode": "each"
        }
      },
      "id": "upload-doc",
      "name": "Upload to Drive",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        3740,
        100
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "uploaded_documents",
        "options": {}
      },
      "id": "aggregate-uploads",
      "name": "Aggregate Uploads",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3960,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst uploads = item.json.uploaded_documents || [];\nconst successful = uploads.filter(u => u.status === 'uploaded');\nconst failed = uploads.filter(u => u.status !== 'uploaded');\n\nconst summary = {\n  execution_id: $execution.id,\n  status: failed.length === 0 ? 'completed' : 'completed_with_errors',\n  documents_generated: uploads.length,\n  successful_uploads: successful.length,\n  failed_uploads: failed.length,\n  uploaded_files: successful.map(u => ({ file_name: u.file_name, file_id: u.file_id, web_link: u.web_link })),\n  errors: failed.map(f => f.error || 'Unknown error'),\n  completed_at: new Date().toISOString()\n};\n\nreturn [{ json: summary }];"
      },
      "id": "generate-summary",
      "name": "Generate Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4180,
        100
      ]
    },
    {
      "parameters": {
        "url": "https://chat.googleapis.com/v1/spaces/SPACE_ID/messages?key=API_KEY&token=TOKEN",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"text\": \"Document Regeneration Complete - Generated: {{ $json.documents_generated }}, Uploaded: {{ $json.successful_uploads }}, Failed: {{ $json.failed_uploads }}\"}",
        "options": {}
      },
      "id": "notify-completion",
      "name": "Notify Completion",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4400,
        100
      ],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger (Webhook)": {
      "main": [
        [
          {
            "node": "Merge Triggers",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Triggers": {
      "main": [
        [
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Variables": {
      "main": [
        [
          {
            "node": "Clear Static Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clear Static Data": {
      "main": [
        [
          {
            "node": "Fetch Company Snippet",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch Enrichment Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Context",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Fetch Company Snippet": {
      "main": [
        [
          {
            "node": "Merge Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Enrichment Data": {
      "main": [
        [
          {
            "node": "Merge Context",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Context": {
      "main": [
        [
          {
            "node": "Combine Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Context": {
      "main": [
        [
          {
            "node": "Scan Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scan Google Drive": {
      "main": [
        [
          {
            "node": "Prepare Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Documents": {
      "main": [
        [
          {
            "node": "Download from Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download from Drive": {
      "main": [
        [
          {
            "node": "Tika Extract Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tika Extract Text": {
      "main": [
        [
          {
            "node": "Format Tika Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Tika Response": {
      "main": [
        [
          {
            "node": "Prepare for Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Analysis": {
      "main": [
        [
          {
            "node": "Analyze Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Document": {
      "main": [
        [
          {
            "node": "Aggregate Analyzed",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Update": {
      "main": [
        [
          {
            "node": "Update Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Document": {
      "main": [
        [
          {
            "node": "Filter Updated Docs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Updated Docs": {
      "main": [
        [
          {
            "node": "Upload Updated Docs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Skipped Updates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Analyzed": {
      "main": [
        [
          {
            "node": "Route to Generators",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route to Generators": {
      "main": [
        [
          {
            "node": "Generate Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Document": {
      "main": [
        [
          {
            "node": "Generate Visuals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Visuals": {
      "main": [
        [
          {
            "node": "Upload to Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Drive": {
      "main": [
        [
          {
            "node": "Aggregate Uploads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Uploads": {
      "main": [
        [
          {
            "node": "Generate Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Summary": {
      "main": [
        [
          {
            "node": "Notify Completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "main"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1"
}